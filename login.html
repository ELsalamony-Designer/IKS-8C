<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <style>
    body{font-family:Arial;background:#0b0f14;color:#e6edf3;margin:0;display:grid;place-items:center;height:100vh}
    .card{background:#121821;border:1px solid #233041;border-radius:16px;padding:24px;width:340px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h2{margin:0 0 16px 0}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3340;background:#0f141b;color:#e6edf3;margin:8px 0}
    .btn{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3340;background:#151b24;color:#d9e2ef;cursor:pointer;margin:6px 0}
    .btn.primary{border:0;background:linear-gradient(45deg,#7c3aed,#22d3ee);color:#fff}
    .small{font-size:12px;color:#9fb0c6;text-align:center;margin-top:8px}
    #err{color:#ffb4b4;font-size:12px;min-height:16px;margin:6px 0 0 0}
  </style>
  <script type="module">
    import { auth, db, googleProvider } from "./firebase.js";
    import { signInWithEmailAndPassword, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const $ = (id)=>document.getElementById(id);
    const showErr = (msg)=>{$("err").innerText = msg || "";};

    onAuthStateChanged(auth,(u)=>{
      if(u) location.href = "app.html";
    });

    window.loginEmail = async ()=>{
      showErr("");
      const email = $("email").value.trim();
      const pass = $("pass").value;
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        location.href = "app.html";
      }catch(e){
        showErr(e.message);
      }
    };

    window.loginGoogle = async ()=>{
      showErr("");
      try{
        const res = await signInWithPopup(auth, googleProvider);
        const u = res.user;
        // ensure user profile in DB
        const snap = await get(ref(db,"users/"+u.uid));
        if(!snap.exists()){
          await set(ref(db,"users/"+u.uid),{
            name: u.displayName || "Student",
            email: u.email || "",
            role: "student",
            createdAt: Date.now()
          });
        }
        location.href = "app.html";
      }catch(e){
        showErr(e.message + "\nMake sure Google Sign-in is enabled in Firebase Console.");
      }
    };
  </script>
</head>
<body>
  <div class="card">
    <h2>Login</h2>
    <input id="email" class="input" type="email" placeholder="Email">
    <input id="pass" class="input" type="password" placeholder="Password">
    <button class="btn primary" onclick="loginEmail()">Login</button>
    <button class="btn" onclick="loginGoogle()">Login with Google</button>
    <div id="err"></div>
    <div class="small">No account? <a href="signup.html">Sign up</a></div>
  </div>
</body>
</html>
