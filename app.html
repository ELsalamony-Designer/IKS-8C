<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IKS 8C – App</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>IKS 8C – Homework Hub</h1>
      <p id="welcomeMsg"></p>
      <button id="logoutBtn" class="btn secondary">Logout</button>
    </div>

    <!-- Navigation -->
    <div class="nav">
      <button class="btn secondary subject-btn" data-subject="Arabic">Arabic</button>
      <button class="btn secondary subject-btn" data-subject="English">English</button>
      <button class="btn secondary subject-btn" data-subject="EnglishPlus">English+</button>
      <button class="btn secondary subject-btn" data-subject="ICT">ICT</button>
      <button class="btn secondary subject-btn" data-subject="Science">Science</button>
      <button class="btn secondary subject-btn" data-subject="Social">Social Studies</button>
      <button class="btn secondary subject-btn" data-subject="Economics">Economics</button>
      <button class="btn secondary" id="chatBtn">Chat</button>
      <button class="btn secondary hidden" id="adminBtn">Admin Panel</button>
    </div>

    <!-- Homework Section -->
    <div id="homeworkSection" class="card hidden">
      <h2 id="subjectTitle"></h2>
      <div id="homeworkList"></div>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="card hidden">
      <h2>Class Chat</h2>
      <div class="chat-box" id="chatBox"></div>
      <input id="chatMsg" class="input" placeholder="Write a message...">
      <button id="sendMsg" class="btn primary">Send</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminSection" class="card hidden">
      <h2>Admin Panel</h2>
      
      <h3>All Users</h3>
      <table class="table" id="usersTable">
        <thead>
          <tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <h3>Add Homework</h3>
      <select id="hwSubject" class="input">
        <option value="Arabic">Arabic</option>
        <option value="English">English</option>
        <option value="EnglishPlus">English+</option>
        <option value="ICT">ICT</option>
        <option value="Science">Science</option>
        <option value="Social">Social Studies</option>
        <option value="Economics">Economics</option>
      </select>
      <input id="hwText" class="input" placeholder="Homework text (optional)">
      <input id="hwFile" type="file" class="input">
      <button id="addHwBtn" class="btn primary">Add Homework</button>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from "./firebase.js";
    import { ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const welcomeMsg = document.getElementById("welcomeMsg");
    const logoutBtn = document.getElementById("logoutBtn");
    const subjectBtns = document.querySelectorAll(".subject-btn");
    const homeworkSection = document.getElementById("homeworkSection");
    const subjectTitle = document.getElementById("subjectTitle");
    const homeworkList = document.getElementById("homeworkList");
    const chatBtn = document.getElementById("chatBtn");
    const chatSection = document.getElementById("chatSection");
    const chatBox = document.getElementById("chatBox");
    const chatMsg = document.getElementById("chatMsg");
    const sendMsg = document.getElementById("sendMsg");
    const adminBtn = document.getElementById("adminBtn");
    const adminSection = document.getElementById("adminSection");
    const usersTable = document.getElementById("usersTable").querySelector("tbody");
    const hwSubject = document.getElementById("hwSubject");
    const hwText = document.getElementById("hwText");
    const hwFile = document.getElementById("hwFile");
    const addHwBtn = document.getElementById("addHwBtn");

    let currentUser = null;
    let currentSubject = null;

    // Auth state
    onAuthStateChanged(auth, user=>{
      if(user){
        currentUser = user;
        // Get user info from DB
        onValue(ref(db,"users/"+user.uid),(snap)=>{
          if(snap.exists()){
            const data = snap.val();
            welcomeMsg.innerText = "Welcome, "+data.name;
            if(data.role === "admin"){
              adminBtn.classList.remove("hidden");
            }
          }else{
            welcomeMsg.innerText = "Welcome, "+(user.email||"Guest");
          }
        });
      }else{
        currentUser = null;
        welcomeMsg.innerText = "Guest mode";
      }
    });

    // Logout
    logoutBtn.onclick = ()=>signOut(auth).then(()=>location.href="index.html");

    // Subjects
    subjectBtns.forEach(btn=>{
      btn.onclick = ()=>{
        currentSubject = btn.dataset.subject;
        subjectTitle.innerText = currentSubject+" Homework";
        homeworkSection.classList.remove("hidden");
        chatSection.classList.add("hidden");
        adminSection.classList.add("hidden");

        // Load homework
        onValue(ref(db,"homework/"+currentSubject),(snap)=>{
          homeworkList.innerHTML = "";
          snap.forEach(hw=>{
            const data = hw.val();
            const div = document.createElement("div");
            div.className="card";
            div.innerHTML = `<p>${data.text||""}</p>`+(data.file?`<a href="${data.file}" target="_blank">Attachment</a>`:"");
            homeworkList.appendChild(div);
          });
        });
      };
    });

    // Chat
    chatBtn.onclick = ()=>{
      homeworkSection.classList.add("hidden");
      adminSection.classList.add("hidden");
      chatSection.classList.remove("hidden");
      chatBox.innerHTML="";
      onValue(ref(db,"chat"),(snap)=>{
        chatBox.innerHTML="";
        snap.forEach(msg=>{
          const m = msg.val();
          const div = document.createElement("div");
          div.className="message"+(m.uid===currentUser?.uid?" me":"");
          div.innerText = m.name+": "+m.text;
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    };
    sendMsg.onclick = ()=>{
      if(!chatMsg.value) return;
      push(ref(db,"chat"),{
        uid:currentUser?.uid||"guest",
        name:currentUser?.displayName||"Guest",
        text:chatMsg.value,
        time:Date.now()
      });
      chatMsg.value="";
    };

    // Admin
    adminBtn.onclick = ()=>{
      homeworkSection.classList.add("hidden");
      chatSection.classList.add("hidden");
      adminSection.classList.remove("hidden");
      // Load users
      onValue(ref(db,"users"),(snap)=>{
        usersTable.innerHTML="";
        snap.forEach(u=>{
          const d = u.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d.name}</td><td>${d.email}</td><td>${d.role}</td>
          <td><button data-id="${u.key}" class="btn secondary delUser">Delete</button></td>`;
          usersTable.appendChild(tr);
        });
        document.querySelectorAll(".delUser").forEach(b=>{
          b.onclick = ()=>remove(ref(db,"users/"+b.dataset.id));
        });
      });
    };

    addHwBtn.onclick = async ()=>{
      const subject = hwSubject.value;
      let fileUrl = null;
      if(hwFile.files[0]){
        const fileRef = sRef(storage,"homework/"+Date.now()+"_"+hwFile.files[0].name);
        await uploadBytes(fileRef,hwFile.files[0]);
        fileUrl = await getDownloadURL(fileRef);
      }
      push(ref(db,"homework/"+subject),{
        text:hwText.value,
        file:fileUrl
      });
      hwText.value=""; hwFile.value="";
      alert("Homework added!");
    };
  </script>
</body>
</html>
